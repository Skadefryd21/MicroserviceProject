name: CI_dotnet_build_&_test

on: [pull_request, push] 

jobs:
  build-and-test:

    runs-on: [windows-latest]

    steps:
    - uses: actions/checkout@v3
    
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: 6.0.x

    - name: Show Dir
      run: ls
      
    - name: Build
      run: dotnet build ./PlatformService/PlatformService.sln
      
    - name: Test
      run: dotnet test ./PlatformService/PlatformRepoTest/PlatformRepoTest.csproj --no-build --verbosity normal
  
  Build-Push-Image-to-GCR: 
    runs-on: [ubuntu-latest]
    needs: build-and-test

    env:
      IMAGE_NAME: Platformservice
      PROJECT_ID: psychic-surf-420214
    
    steps:
      - name: Checkout
        uses: actions/checkout@v3
   
   
      - name: Google auth
        id: auth
        uses: google-github-actions/auth@v1
        with:
            workload_identity_provider: '${{ secrets.WIF_PROVIDER }}'
            service_account: '${{ secrets.WIF_SERVICE_ACCOUNT }}'
    
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v1
        with:
            project_id: '${{ env.PROJECT_ID }}'

      - name: Build Docker Image
        run: docker build -t $IMAGE_NAME:latest .

      - name: Configure Docker Client
        run: |-
            gcloud auth configure-docker --quiet
      
      - name: Push Docker Image to Container Registry (GCR)
        env:
          GIT_TAG: v0.1.0
        run: |-
          docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
          docker tag $IMAGE_NAME:latest gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG
          docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:latest
          docker push gcr.io/$PROJECT_ID/$IMAGE_NAME:$GIT_TAG

